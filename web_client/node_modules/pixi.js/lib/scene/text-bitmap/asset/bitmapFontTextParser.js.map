{"version":3,"file":"bitmapFontTextParser.js","sources":["../../../../src/scene/text-bitmap/asset/bitmapFontTextParser.ts"],"sourcesContent":["import type { BitmapFontData, RawCharData } from '../AbstractBitmapFont';\n\n/**\n * Internal data format used to convert to BitmapFontData.\n * @private\n */\nexport interface BitmapFontRawData\n{\n    info: {\n        face: string;\n        size: string;\n    }[];\n    common: { lineHeight: string, base: string }[];\n    page: {\n        id: string;\n        file: string;\n    }[];\n    chars: {\n        count: number;\n    }[];\n    char: {\n        id: string\n        page: string\n        xoffset: string\n        yoffset: string\n        xadvance: string,\n        x: string\n        y: string\n        width: string\n        height: string\n        letter?: string\n        char?: string\n    }[];\n    kernings?: {\n        count: number;\n    }[];\n    kerning?: {\n        first: string;\n        second: string;\n        amount: string;\n    }[];\n    distanceField?: {\n        fieldType: 'sdf' | 'msdf' | 'none';\n        distanceRange: string;\n    }[]\n}\n\n/** @internal */\nexport const bitmapFontTextParser = {\n    test(data: string | XMLDocument | BitmapFontData): boolean\n    {\n        return typeof data === 'string' && data.startsWith('info face=');\n    },\n\n    parse(txt: string): BitmapFontData\n    {\n        // Retrieve data item\n        const items = txt.match(/^[a-z]+\\s+.+$/gm);\n        const rawData: BitmapFontRawData = {\n            info: [],\n            common: [],\n            page: [],\n            char: [],\n            chars: [],\n            kerning: [],\n            kernings: [],\n            distanceField: [],\n        };\n\n        for (const i in items)\n        {\n            // Extract item name\n            const name = items[i].match(/^[a-z]+/gm)[0] as keyof BitmapFontRawData;\n\n            // Extract item attribute list as string ex.: \"width=10\"\n            const attributeList = items[i].match(/[a-zA-Z]+=([^\\s\"']+|\"([^\"]*)\")/gm);\n\n            // Convert attribute list into an object\n            const itemData: any = {};\n\n            for (const i in attributeList)\n            {\n                // Split key-value pairs\n                const split = attributeList[i].split('=');\n                const key = split[0];\n\n                // Remove eventual quotes from value\n                const strValue = split[1].replace(/\"/gm, '');\n\n                // Try to convert value into float\n                const floatValue = parseFloat(strValue);\n\n                // Use string value case float value is NaN\n                const value = isNaN(floatValue) ? strValue : floatValue;\n\n                itemData[key] = value;\n            }\n\n            // Push current item to the resulting data\n            rawData[name].push(itemData);\n        }\n\n        const font: BitmapFontData = {\n            chars: {},\n            pages: [],\n            lineHeight: 0,\n            fontSize: 0,\n            fontFamily: '',\n            distanceField: null,\n            baseLineOffset: 0,\n        };\n\n        const [info] = rawData.info;\n        const [common] = rawData.common;\n        const [distanceField] = rawData.distanceField ?? [];\n\n        if (distanceField)\n        {\n            font.distanceField = {\n                range: parseInt(distanceField.distanceRange, 10),\n                type: distanceField.fieldType\n            };\n        }\n\n        font.fontSize = parseInt(info.size, 10);\n        font.fontFamily = info.face;\n        font.lineHeight = parseInt(common.lineHeight, 10);\n\n        const page = rawData.page;\n\n        for (let i = 0; i < page.length; i++)\n        {\n            font.pages.push({\n                id: parseInt(page[i].id, 10) || 0,\n                file: page[i].file,\n            });\n        }\n\n        const map: Record<string, string> = {};\n\n        font.baseLineOffset = font.lineHeight - parseInt(common.base, 10);\n\n        const char = rawData.char;\n\n        for (let i = 0; i < char.length; i++)\n        {\n            const charNode = char[i];\n            const id = parseInt(charNode.id, 10);\n\n            let letter = charNode.letter ?? charNode.char ?? String.fromCharCode(id);\n\n            if (letter === 'space')letter = ' ';\n\n            map[id] = letter;\n\n            font.chars[letter] = {\n                id,\n                // texture deets..\n                page: parseInt(charNode.page, 10) || 0,\n                x: parseInt(charNode.x, 10),\n                y: parseInt(charNode.y, 10),\n                width: parseInt(charNode.width, 10),\n                height: parseInt(charNode.height, 10),\n                xOffset: parseInt(charNode.xoffset, 10),\n                yOffset: parseInt(charNode.yoffset, 10),\n                xAdvance: parseInt(charNode.xadvance, 10),\n                kerning: {},\n            } as RawCharData;\n        }\n\n        const kerning = rawData.kerning || [];\n\n        for (let i = 0; i < kerning.length; i++)\n        {\n            const first = parseInt(kerning[i].first, 10);\n            const second = parseInt(kerning[i].second, 10);\n            const amount = parseInt(kerning[i].amount, 10);\n\n            font.chars[map[second]].kerning[map[first]] = amount;\n        }\n\n        return font;\n    }\n};\n"],"names":["i"],"mappings":"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"}